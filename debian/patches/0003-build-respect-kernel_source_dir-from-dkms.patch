From: "You-Sheng Yang (vicamo)" <vicamo@gmail.com>
Date: Wed, 27 Apr 2022 18:04:21 +0800
Subject: build: respect kernel_source_dir from dkms

Signed-off-by: You-Sheng Yang (vicamo) <vicamo@gmail.com>
---
 Makefile  | 4 ++--
 dkms.conf | 3 +++
 2 files changed, 5 insertions(+), 2 deletions(-)

diff --git a/Makefile b/Makefile
index cd26065..d1bb2f2 100644
--- a/Makefile
+++ b/Makefile
@@ -11,8 +11,8 @@ export CONFIG_VIDEO_OV01A1S = m
 export CONFIG_POWER_CTRL_LOGIC = m
 obj-y += drivers/media/i2c/
 
-KERNELRELEASE	?= `uname -r`
-KERNEL_SRC := /lib/modules/$(KERNELRELEASE)/build
+KERNELRELEASE ?= $(shell uname -r)
+KERNEL_SRC ?= /lib/modules/$(KERNELRELEASE)/build
 MODSRC := $(shell pwd)
 subdir-ccflags-y += -I$(src)/include/
 
diff --git a/dkms.conf b/dkms.conf
index c5b6169..edab69b 100644
--- a/dkms.conf
+++ b/dkms.conf
@@ -1,6 +1,9 @@
 PACKAGE_NAME=ipu6-drivers
 PACKAGE_VERSION=0.0.0
 
+MAKE="make KERNELRELEASE=$kernelver KERNEL_SRC=$kernel_source_dir"
+CLEAN="make KERNELRELEASE=$kernelver KERNEL_SRC=$kernel_source_dir clean"
+
 BUILT_MODULE_NAME[0]="intel-ipu6"
 BUILT_MODULE_LOCATION[0]="drivers/media/pci/intel/ipu6"
 DEST_MODULE_LOCATION[0]="/kernel/drivers/media/pci/intel/ipu6"
